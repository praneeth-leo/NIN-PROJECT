<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SurveyPro - Secure Login</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Inter", sans-serif;
      background: #070b14;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: #fff;
    }
    .box {
      width: 100%;
      max-width: 440px;
      background: rgba(12, 18, 28, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 28px;
      padding: 36px 30px;
      box-shadow: 0 24px 50px rgba(0, 0, 0, 0.5);
    }
    .brand-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      border-radius: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #1e2538, #131b2c);
    }
    .brand-icon i {
      font-size: 34px;
      background: linear-gradient(145deg, #818cf8, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    h2 {
      text-align: center;
      font-size: 1.9rem;
      margin-bottom: 8px;
    }
    .sub {
      text-align: center;
      color: #b1c3ff;
      margin-bottom: 24px;
      font-size: 0.95rem;
    }
    .input-group {
      position: relative;
      margin-bottom: 14px;
    }
    .input-group i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #7e8bb6;
    }
    input {
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.03);
      color: #fff;
      border-radius: 12px;
      padding: 12px 14px 12px 40px;
      font-size: 0.95rem;
    }
    input:focus {
      outline: none;
      border-color: #6366f1;
    }
    .login-btn, .profile-btn {
      width: 100%;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      margin-top: 6px;
    }
    .login-btn { background: linear-gradient(145deg, #6366f1, #8b5cf6); }
    .profile-btn { background: linear-gradient(145deg, #22c55e, #16a34a); }
    .divider {
      margin: 16px 0;
      text-align: center;
      color: #9fb0e3;
      font-size: 0.9rem;
    }
    .error {
      margin-top: 12px;
      text-align: center;
      color: #fecaca;
      font-size: 0.9rem;
    }
    .note {
      margin-top: 18px;
      text-align: center;
      color: #9fb0e3;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="box">
    <div class="brand-icon"><i class="fas fa-qrcode"></i></div>
    <h2>Welcome back</h2>
    <div class="sub">Secure barcode access</div>

    <form method="POST" action="/login" id="barcode-login-form">
      <div class="input-group">
        <i class="fas fa-barcode"></i>
        <input type="text" name="profile_id" id="profile_id_input" placeholder="Enter your barcode ID" autocomplete="off" autofocus required />
      </div>
      <button type="submit" class="login-btn">Login with barcode</button>
    </form>

    <div class="divider">new here?</div>
    <button class="profile-btn" onclick="window.location.href='/profile'">Create new profile</button>

    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}

    <div class="note">All survey responses are linked to the participant barcode ID</div>
  </div>

  <script>
    (function () {
      const form = document.getElementById("barcode-login-form");
      const input = document.getElementById("profile_id_input");
      if (!form || !input) return;

      // Keep focus for keyboard-wedge barcode scanners.
      setTimeout(() => input.focus(), 0);
      document.addEventListener("click", function () {
        if (document.activeElement !== input) input.focus();
      });

      // Scanner capture fallback: many scanners type fast chars + Enter/Tab.
      let scanBuffer = "";
      let scanTimer = null;
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey || e.altKey || e.metaKey) return;
        if (e.key === "Enter" || e.key === "Tab") {
          const current = (input.value || "").replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
          const buffered = (scanBuffer || "").replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
          const finalId = current || buffered;
          if (finalId.length >= 4) {
            input.value = finalId;
            if (typeof form.requestSubmit === "function") {
              form.requestSubmit();
            } else {
              form.dispatchEvent(new Event("submit", { cancelable: true }));
              form.submit();
            }
            e.preventDefault();
          }
          scanBuffer = "";
          return;
        }
        if (e.key.length === 1) {
          scanBuffer += e.key;
          if (scanTimer) clearTimeout(scanTimer);
          scanTimer = setTimeout(() => { scanBuffer = ""; }, 600);
        }
      });

      input.addEventListener("input", function () {
        input.value = (input.value || "").replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
      });
    })();
  </script>
</body>
</html>
